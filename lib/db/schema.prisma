// Prisma Schema for Church Management System
// Run: npx prisma generate
// Run: npx prisma db push (for development)
// Run: npx prisma migrate dev (for production migrations)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // Using SQLite for local development
  url      = env("DATABASE_URL")
}

// ===========================
// USER & AUTHENTICATION
// ===========================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  phone         String?
  image         String?
  role          String    @default("member")
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  rsvps         RSVP[]
  prayerRequests PrayerRequest[]
  interactions  PrayerInteraction[]
  donations     Donation[]
  volunteerSignups VolunteerSignup[]
  volunteerAssignments VolunteerAssignment[]

  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ===========================
// EVENTS & RSVP
// ===========================

model Event {
  id              String    @id @default(cuid())
  title           String
  slug            String    @unique
  description     String
  date            DateTime
  endDate         DateTime?
  location        String
  category        String
  image           String?
  maxCapacity     Int?
  currentAttendees Int      @default(0)
  requiresRsvp    Boolean   @default(false)
  rsvpDeadline    DateTime?
  featured        Boolean   @default(false)
  status          String    @default("upcoming") // upcoming, ongoing, completed, cancelled

  // Recurring event fields
  isRecurring     Boolean   @default(false)
  recurringFrequency String? // daily, weekly, biweekly, monthly
  recurringEndDate DateTime?
  recurringParentId String?

  // Organizer info
  organizerName   String
  organizerEmail  String
  organizerPhone  String?

  tags            String   @default("[]") // JSON array stored as string

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  rsvps           RSVP[]

  @@index([date])
  @@index([category])
  @@index([status])
  @@index([slug])
}

model RSVP {
  id                  String   @id @default(cuid())
  eventId             String
  userId              String?
  name                String
  email               String
  phone               String?
  numberOfGuests      Int      @default(0)
  dietaryRestrictions String?
  specialNeeds        String?
  notes               String?
  status              String   @default("confirmed") // confirmed, waitlisted, cancelled
  confirmationCode    String   @unique

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  event               Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user                User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([eventId])
  @@index([email])
  @@index([confirmationCode])
}

// ===========================
// PRAYER WALL
// ===========================

model PrayerRequest {
  id          String   @id @default(cuid())
  name        String
  request     String
  category    String
  isAnonymous Boolean  @default(false)
  isPublic    Boolean  @default(true)
  approved    Boolean  @default(false)
  prayerCount Int      @default(0)

  userId      String?
  userEmail   String?

  submittedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User?              @relation(fields: [userId], references: [id], onDelete: SetNull)
  interactions PrayerInteraction[]

  @@index([approved, isPublic])
  @@index([category])
  @@index([submittedAt])
}

model PrayerInteraction {
  id        String   @id @default(cuid())
  requestId String
  userId    String
  type      String   // prayed, commented
  timestamp DateTime @default(now())

  // Relations
  request   PrayerRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([requestId, userId, type])
  @@index([requestId])
  @@index([userId])
}

// ===========================
// DONATIONS
// ===========================

model Donation {
  id              String   @id @default(cuid())
  userId          String?
  amount          Float
  currency        String   @default("USD")
  fund            String   // general, missions, building, etc.
  frequency       String   // one-time, weekly, monthly, yearly
  status          String   // pending, completed, failed, refunded

  // Donor info (for non-users)
  donorName       String?
  donorEmail      String?

  // Payment info
  stripePaymentId String?  @unique
  stripeCustomerId String?

  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// ===========================
// VOLUNTEERS
// ===========================

model VolunteerOpportunity {
  id              String   @id @default(cuid())
  title           String
  slug            String   @unique
  category        String
  description     String
  commitment      String   // e.g., "Weekly", "Monthly", "One-time"
  requirements    String?
  contactPerson   String
  contactEmail    String
  active          Boolean  @default(true)
  featured        Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  signups         VolunteerSignup[]

  @@index([active])
  @@index([slug])
}

model VolunteerSignup {
  id              String   @id @default(cuid())
  opportunityId   String
  userId          String?
  name            String
  email           String
  phone           String?
  message         String?
  status          String   @default("pending") // pending, approved, declined

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  opportunity     VolunteerOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  user            User?                @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([opportunityId])
  @@index([userId])
  @@index([status])
}

model VolunteerRole {
  id                      String   @id @default(cuid())
  name                    String
  description             String
  ministry                String
  requirements            String   @default("[]") // JSON array stored as string
  training                String?
  commitment              String   // one-time, weekly, monthly, as-needed
  minAge                  Int?
  backgroundCheckRequired Boolean  @default(false)
  skills                  String   @default("[]") // JSON array stored as string
  isActive                Boolean  @default(true)

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Relations
  shifts                  VolunteerShift[]
  assignments             VolunteerAssignment[]

  @@index([ministry])
  @@index([isActive])
}

model VolunteerShift {
  id              String   @id @default(cuid())
  roleId          String
  eventId         String?
  title           String
  description     String?
  date            DateTime
  startTime       String   // HH:MM format
  endTime         String   // HH:MM format
  location        String
  spotsNeeded     Int
  spotsFilled     Int      @default(0)
  status          String   @default("open") // open, filled, cancelled
  notes           String?
  reminderSent    Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  role            VolunteerRole @relation(fields: [roleId], references: [id], onDelete: Cascade)
  volunteers      VolunteerAssignment[]

  @@index([roleId])
  @@index([date])
  @@index([status])
}

model VolunteerAssignment {
  id              String   @id @default(cuid())
  shiftId         String
  userId          String?
  name            String   // Stored in case user is deleted
  email           String   // Stored in case user is deleted
  roleId          String
  status          String   @default("scheduled") // scheduled, confirmed, completed, no-show, cancelled
  checkedIn       Boolean  @default(false)
  checkedInTime   DateTime?
  checkedOutTime  DateTime?
  notes           String?
  rating          Int?     // 1-5 rating
  feedback        String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  shift           VolunteerShift @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  user            User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  role            VolunteerRole  @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@index([shiftId])
  @@index([userId])
  @@index([roleId])
  @@index([status])
}

// ===========================
// CONTENT (Optional - if not using Sanity)
// ===========================

model Sermon {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  speaker     String
  date        DateTime
  scripture   String?
  series      String?
  description String?
  audioUrl    String?
  videoUrl    String?
  tags        String   @default("[]") // JSON array stored as string
  featured    Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
  @@index([slug])
}

model News {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  author      String
  category    String
  excerpt     String?
  content     String
  image       String?
  featured    Boolean  @default(false)

  publishedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([publishedAt])
  @@index([slug])
}

// ===========================
// SETTINGS (Dynamic Config)
// ===========================

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  category  String   // site, events, prayer, giving, etc.
  type      String   // string, number, boolean, json

  updatedAt DateTime @updatedAt

  @@index([category])
}
